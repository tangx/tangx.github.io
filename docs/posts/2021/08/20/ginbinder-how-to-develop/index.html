<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>ginbinder 的书写过程-一起来看gin源码吧 | 老麦的书房</title><meta property="og:title" content="ginbinder 的书写过程-一起来看gin源码吧 - 老麦的书房"><meta property="og:type" content="article"><meta property="article:published_time" content="2021-08-20T00:00:00+08:00"><meta property="article:modified_time" content="2021-08-20T00:00:00+08:00"><meta name=Keywords content="[go,reflect]"><meta name=description content="在开发 ginbinder 过程中的一些知识点"><meta name=author content="老麦"><meta property="og:url" content="https://typonotes.com/posts/2021/08/20/ginbinder-how-to-develop/"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=/css/normalize.css><link rel=stylesheet href=/css/style.css><script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5359126171348711" crossorigin=anonymous></script>
<script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?fe891ffeb313a7d084b8baf803d87746",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-V3S2RT0KBC"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-V3S2RT0KBC")</script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><a id=logo href=https://typonotes.com/>老麦的书房</a><p class=description>Go语言(golang)、 云原生、 DevOps、 可视化追踪。 React 入门。</p></div><div><nav id=nav-menu class=clearfix><a class=current href=https://typonotes.com/>首页</a>
<a href=https://typonotes.com/books/ title=开源书>开源书</a>
<a href=https://typonotes.com/categories/ title=分类>分类</a>
<a href=https://typonotes.com/tags/ title=标签>标签</a>
<a href=https://typonotes.com/links/ title=友链>友链</a></nav></div></div></div></header><div id=body><div class=container><div style=margin:10px></div><div class=col-group><div class=col-8 id=main><div style="margin:5px 0"><form id=search action=https://typonotes.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch value=https://typonotes.com/>
<button type=submit class="submit icon-search"></button></form></div><div class=res-cons><style type=text/css>.post-toc{position:fixed;width:200px;margin-left:-210px;padding:5px 10px;font-family:Athelas,STHeiti,Microsoft Yahei,serif;font-size:12px;border:1px solid rgba(0,0,0,7%);border-radius:5px;background-color:rgba(255,255,255,.98);background-clip:padding-box;-webkit-box-shadow:1px 1px 2px rgba(0,0,0,.125);box-shadow:1px 1px 2px rgba(0,0,0,.125);word-wrap:break-word;white-space:nowrap;-webkit-box-sizing:border-box;box-sizing:border-box;z-index:999;cursor:pointer;max-height:70%;overflow-y:auto;overflow-x:hidden}.post-toc .post-toc-title{width:100%;margin:0 auto;font-size:20px;font-weight:400;text-transform:uppercase;text-align:center}.post-toc .post-toc-content{font-size:15px}.post-toc .post-toc-content>nav>ul{margin:10px 0}.post-toc .post-toc-content ul{padding-left:20px;list-style:square;margin:.5em;line-height:1.8em}.post-toc .post-toc-content ul ul{padding-left:15px;display:none}@media print,screen and (max-width:1057px){.post-toc{display:none}}</style><div class=post-toc style=position:absolute;top:188px><h2 class=post-toc-title>文章目录</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#那么开始吧>那么，开始吧</a><ul><li><a href=#cbind><code>c.Bind</code></a></li><li><a href=#cshouldbindwith><code>c.ShouldBindWith</code></a></li><li><a href=#绑定器-binders>绑定器 binders</a></li></ul></li><li><a href=#改造开始>改造开始</a><ul><li><a href=#gin-原生拆分接口>gin 原生拆分接口</a></li></ul></li><li><a href=#ginbinder-设计>ginbinder 设计</a><ul><li><a href=#怎么锁定数据来源>怎么锁定数据来源</a></li><li><a href=#非-body-数据处理>非 Body 数据处理</a></li><li><a href=#body-数据处理>Body 数据处理</a></li></ul></li><li><a href=#封装一下>封装一下</a></li></ul></nav></div></div><script type=text/javascript>$(document).ready(function(){if(e=$(".post-toc"),e.length){t=$("#main").offset().left,t<220&&e.css({width:t-10,"margin-left":0-t});var e,t,n=e.offset().top-20,s={start:{position:"absolute",top:n},process:{position:"fixed",top:20}};$(window).scroll(function(){var t=$(window).scrollTop();t<n?e.css(s.start):e.css(s.process)})}$("#TableOfContents").children().length<1&&$(".post-toc").remove()})</script><article class=post><header><h1 class=post-title>ginbinder 的书写过程-一起来看gin源码吧</h1></header><time datetime=2021-08-20T00:00:00Z class="post-meta meta-date dt-published">2021年8月20日</time><div class=post-meta><span id=busuanzi_container_page_pv>&nbsp;|
<span id=busuanzi_value_page_pv></span> <span>阅读</span></span></div><div class=post-content><h1 id=ginbind-的实现过程-一起来看gin源码吧>ginbind 的实现过程-一起来看gin源码吧</h1><p>是的，没错。</p><p>如果你用过 <code>gin</code> 那么你一定知道，<code>gin</code> 中绑定参数的方式很零散。 <code>c *gon.Context</code> 给你提供了很多中方法， 例如<code>BindHeader</code>, <code>BindURI</code> 等等， 但是如果想要绑定 reqeust 中不同地方的参数， 那对不起咯，并没有。</p><p>另外， gin 中的 <code>Bind</code> 接口， 默认是包含了 <strong>参数验证 validate</strong> 功能的， 因此如果你想直接使用默认的绑定方法， 就会出现很多验证不通过的情况。这里有一公升的泪水。</p><p>鉴于以上两点， 不得不自己改造 gin， 然后提 PR
<a href=https://github.com/gin-gonic/gin/pull/2812 target=_blank rel=noopener>feat: add methods <code>c.BindCookie(obj)</code> from cookie and <code>c.BindRequest(obj)</code> from http request #2812</a>
。</p><p>然而， 我自己也觉得估计被合并的机会太小了， 对原来的 <code>binder</code> 的改造和破坏有点大。</p><h2 id=那么开始吧>那么，开始吧</h2><h3 id=cbind><code>c.Bind</code></h3><p>gin 中有一个绑定方法 <code>c.Bind(obj)</code> 是一个动态绑定器， 使用它不需要传入什么方法， 就可以绑定 <code>req.Body</code>。</p><p>源码如下，</p><blockquote><p><a href=https://github.com/gin-gonic/gin/blob/v1.7.4/context.go#L661 target=_blank rel=noopener>https://github.com/gin-gonic/gin/blob/v1.7.4/context.go#L661</a></p></blockquote><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#998;font-style:italic>// ShouldBind checks the Content-Type to select a binding engine automatically,
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>// Depending the &#34;Content-Type&#34; header different bindings are used:
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>//     &#34;application/json&#34; --&gt; JSON binding
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>//     &#34;application/xml&#34;  --&gt; XML binding
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>// otherwise --&gt; returns an error
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>// It parses the request&#39;s body as JSON if Content-Type == &#34;application/json&#34; using JSON or XML as a JSON input.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>// It decodes the json payload into the struct specified as a pointer.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>// Like c.Bind() but this method does not set the response status code to 400 and abort if the json is not valid.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>func</span> (c <span style=color:#000;font-weight:700>*</span>Context) <span style=color:#900;font-weight:700>ShouldBind</span>(obj <span style=color:#000;font-weight:700>interface</span>{}) <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span>	b <span style=color:#000;font-weight:700>:=</span> binding.<span style=color:#900;font-weight:700>Default</span>(c.Request.Method, c.<span style=color:#900;font-weight:700>ContentType</span>())
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>return</span> c.<span style=color:#900;font-weight:700>ShouldBindWith</span>(obj, b)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>调用了 <code>binding.Default()</code> 方法， 通过 <code>req.Method</code> 和 <code>content-type</code> 选择了一个 <strong>绑定器</strong> 。 使用 <code>c.ShouldBindWith(obj,b)</code> 执行数据绑定。</p><blockquote><p>这里就不展开了， 点进去之后是一个 switch 表达式， 返回一个 绑定器</p><p><a href=https://github.com/gin-gonic/gin/blob/v1.7.4/binding/binding.go#L90 target=_blank rel=noopener>https://github.com/gin-gonic/gin/blob/v1.7.4/binding/binding.go#L90</a></p></blockquote><h3 id=cshouldbindwith><code>c.ShouldBindWith</code></h3><ol><li><p>跟随 <code>c.ShouldBindWith</code> 来到
<a href=https://github.com/gin-gonic/gin/blob/v1.7.4/context.go#L700 target=_blank rel=noopener>context.go#L703</a>
行， 这里直接调用 <code>c.Bind()</code> 并返回了结果。</p></li><li><p>跟随 <code>c.Bind()</code> 来到
<a href=https://github.com/gin-gonic/gin/blob/v1.7.4/binding/binding.go#L90 target=_blank rel=noopener>binding.go#L30</a>
行， 可以看到，这里是一个接口。</p></li></ol><blockquote><p><a href=https://github.com/gin-gonic/gin/blob/v1.7.4/context.go#L700 target=_blank rel=noopener>https://github.com/gin-gonic/gin/blob/v1.7.4/context.go#L700</a></p><p><a href=https://github.com/gin-gonic/gin/blob/v1.7.4/binding/binding.go#L30 target=_blank rel=noopener>https://github.com/gin-gonic/gin/blob/v1.7.4/binding/binding.go#L30</a></p></blockquote><p>因此， 只要满足了 <code>Binding</code> 接口的的绑定器， 就能使用 <code>c.ShouldBindWith</code></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#998;font-style:italic>// Binding describes the interface which needs to be implemented for binding the
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>// data present in the request such as JSON request body, query parameters or
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>// the form POST.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>type</span> Binding <span style=color:#000;font-weight:700>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#900;font-weight:700>Name</span>() <span style=color:#458;font-weight:700>string</span>
</span></span><span style=display:flex><span>	<span style=color:#900;font-weight:700>Bind</span>(<span style=color:#000;font-weight:700>*</span>http.Request, <span style=color:#000;font-weight:700>interface</span>{}) <span style=color:#458;font-weight:700>error</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic>// BindingBody adds BindBody method to Binding. BindBody is similar with Bind,
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>// but it reads the body from supplied bytes instead of req.Body.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>type</span> BindingBody <span style=color:#000;font-weight:700>interface</span> {
</span></span><span style=display:flex><span>	Binding
</span></span><span style=display:flex><span>	<span style=color:#900;font-weight:700>BindBody</span>([]<span style=color:#458;font-weight:700>byte</span>, <span style=color:#000;font-weight:700>interface</span>{}) <span style=color:#458;font-weight:700>error</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=绑定器-binders>绑定器 binders</h3><p>重新跟随 <code>binding.Defualt</code> 来到
<a href=https://github.com/gin-gonic/gin/blob/v1.7.4/binding/binding.go#L74 target=_blank rel=noopener>binding.go#L74</a>
行， 可以看到这里内置了很多绑定器， 有些都是在 README.md 上没有介绍的，是否有介绍取决于提PR的人是否更新了 README。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#998;font-style:italic>// These implement the Binding interface and can be used to bind the data
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic>// present in the request to struct instances.
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>var</span> (
</span></span><span style=display:flex><span>	JSON          = jsonBinding{}
</span></span><span style=display:flex><span>	XML           = xmlBinding{}
</span></span><span style=display:flex><span>	<span style=color:#998;font-style:italic>// ... 省略
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>	Uri           = uriBinding{}
</span></span><span style=display:flex><span>	Header        = headerBinding{}
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><blockquote><p><a href=https://github.com/gin-gonic/gin/blob/v1.7.4/binding/binding.go#L74 target=_blank rel=noopener>https://github.com/gin-gonic/gin/blob/v1.7.4/binding/binding.go#L74</a></p></blockquote><p>随意点一个点一个进去， 可以看到 binders 是如何实现<strong>具体绑定数据操作的</strong></p><p>例如这里的
<a href=https://github.com/gin-gonic/gin/blob/v1.7.4/binding/uri.go target=_blank rel=noopener>uri.go</a></p><blockquote><p><a href=https://github.com/gin-gonic/gin/blob/v1.7.4/binding/uri.go target=_blank rel=noopener>https://github.com/gin-gonic/gin/blob/v1.7.4/binding/uri.go</a></p></blockquote><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> (uriBinding) <span style=color:#900;font-weight:700>BindUri</span>(m <span style=color:#000;font-weight:700>map</span>[<span style=color:#458;font-weight:700>string</span>][]<span style=color:#458;font-weight:700>string</span>, obj <span style=color:#000;font-weight:700>interface</span>{}) <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>:=</span> <span style=color:#900;font-weight:700>mapUri</span>(obj, m); err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#000;font-weight:700>return</span> err
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>return</span> <span style=color:#900;font-weight:700>validate</span>(obj)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>然后很遗憾的是， 所有 binders 都是返回前都进行了 <code>validate(obj)</code> ，这也就是我之前说的公升泪和汗水。</p><p>如果参数带有 <code>validate</code> 相关的 <code>tag</code>， 无法在一个 Params 结构体中写入所有需要的参数。 然后通过多次调用相关的绑定方法完成所需参数的赋值。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#998;font-style:italic>// 这里会出问题
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>type</span> MyParams{
</span></span><span style=display:flex><span>  Age <span style=color:#458;font-weight:700>int</span> <span style=color:#d14>`form:&#34;age&#34; required:&#34;....&#34;`</span>
</span></span><span style=display:flex><span>  Name <span style=color:#458;font-weight:700>int</span> <span style=color:#d14>`uri:&#34;age&#34; required:&#34;....&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>var</span> obj=<span style=color:#000;font-weight:700>&amp;</span>MyParams{}
</span></span><span style=display:flex><span>err = c.<span style=color:#900;font-weight:700>BindQuery</span>(obj) 
</span></span><span style=display:flex><span>err = c.<span style=color:#900;font-weight:700>BindUri</span>(obj)
</span></span></code></pre></td></tr></table></div></div><p>那么操作阶段就很明显了，</p><ol><li>自己创建一个 binder ， 实现所有的绑定逻辑。</li><li>拆分一下原生的binder 的 <code>bind</code> 和 <code>validate</code> 逻辑， 还是自己创建一个 binder ，复用 <code>bind</code> 逻辑 返回前在执行才执行一次 <code>validate</code></li></ol><p>我这么懒， 肯定选第二种咯</p><h2 id=改造开始>改造开始</h2><h3 id=gin-原生拆分接口>gin 原生拆分接口</h3><p>为了能够复用原生的绑定逻辑， 我把原来的 <code>Binding</code> 接口增加了一个方法 <code>BindOnly</code>。</p><ol><li>新增加的 <code>BindOnly</code> 方法只对数据进行绑定，不做任何 <code>validate</code> 的操作。</li><li><code>Bind</code> 对外保持保持一致，依旧 <code>validate</code> 之后返回数据， 因此对 <code>BindOnly</code> 的返回结果进行 <code>validate</code> 就行了。</li></ol><p>并且对外暴露了两个方法， 使用 <code>BindOnly</code> 就可以解决<strong>用户自由组合</strong> 的问题。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>type</span> Binding <span style=color:#000;font-weight:700>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#900;font-weight:700>Name</span>() <span style=color:#458;font-weight:700>string</span>
</span></span><span style=display:flex><span>	<span style=color:#900;font-weight:700>Bind</span>(<span style=color:#000;font-weight:700>*</span>http.Request, <span style=color:#000;font-weight:700>interface</span>{}) <span style=color:#458;font-weight:700>error</span> <span style=color:#998;font-style:italic>// with validate
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>	<span style=color:#900;font-weight:700>BindOnly</span>(<span style=color:#000;font-weight:700>*</span>http.Request, <span style=color:#000;font-weight:700>interface</span>{}) <span style=color:#458;font-weight:700>error</span> <span style=color:#998;font-style:italic>// without validate
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>}
</span></span></code></pre></td></tr></table></div></div><p>下面是 <code>queryBinding</code> 的对比， 其他类似。</p><p><strong>origin query binder</strong></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#998;font-style:italic>// origin
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>func</span> (queryBinding) <span style=color:#900;font-weight:700>Bind</span>(req <span style=color:#000;font-weight:700>*</span>http.Request, obj <span style=color:#000;font-weight:700>interface</span>{}) <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span>	values <span style=color:#000;font-weight:700>:=</span> req.URL.<span style=color:#900;font-weight:700>Query</span>()
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>:=</span> <span style=color:#900;font-weight:700>mapForm</span>(obj, values); err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#000;font-weight:700>return</span> err
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>return</span> <span style=color:#900;font-weight:700>validate</span>(obj)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p><strong>new query binder</strong></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#998;font-style:italic>// new
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>func</span> (b queryBinding) <span style=color:#900;font-weight:700>Bind</span>(req <span style=color:#000;font-weight:700>*</span>http.Request, obj <span style=color:#000;font-weight:700>interface</span>{}) <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#998;font-style:italic>// 先 BindOnly
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>	<span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>:=</span> b.<span style=color:#900;font-weight:700>BindOnly</span>(req, obj); err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#000;font-weight:700>return</span> err
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#998;font-style:italic>// 数据验证
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>	<span style=color:#000;font-weight:700>return</span> <span style=color:#900;font-weight:700>validate</span>(obj)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> (queryBinding) <span style=color:#900;font-weight:700>BindOnly</span>(req <span style=color:#000;font-weight:700>*</span>http.Request, obj <span style=color:#000;font-weight:700>interface</span>{}) <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span>	values <span style=color:#000;font-weight:700>:=</span> req.URL.<span style=color:#900;font-weight:700>Query</span>()
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>:=</span> <span style=color:#900;font-weight:700>mapForm</span>(obj, values); err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#000;font-weight:700>return</span> err
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=ginbinder-设计>ginbinder 设计</h2><h3 id=怎么锁定数据来源>怎么锁定数据来源</h3><p>先来看看一个 http request 请求是怎么样的</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>POST http://127.0.0.1:9881/demo1/zhangsan?money=1000
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>Content-Type: application/json
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>Accept-Language: en-GB,en-US;q=0.8,en;q=0.6,zh-CN;q=0.4
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>Cookie: Authorization=auth123123;
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>{
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>    &#34;replicas&#34;:5
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2>}
</span></span></span></code></pre></td></tr></table></div></div><ol><li><p>URI 参数: <code>zhangsan</code></p></li><li><p>Query参数: <code>money=1000</code></p></li><li><p>Header 参数: <code>content-type: application/json</code> &mldr;</p></li><li><p>Cookie 参数: <code>Authorization=auth123123;</code></p></li><li><p>Body 参数: <code>{"replicas":5}</code></p></li></ol><p>按照以下这样， 就设计出了了一个参数， 其结构与 Request 请求体类似</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>type</span> Params <span style=color:#000;font-weight:700>struct</span> {
</span></span><span style=display:flex><span>  Name <span style=color:#458;font-weight:700>string</span> <span style=color:#d14>`uri:&#34;name&#34;`</span>
</span></span><span style=display:flex><span>  Money <span style=color:#458;font-weight:700>int</span> <span style=color:#d14>`query:&#34;money&#34;`</span>
</span></span><span style=display:flex><span>  ContentType <span style=color:#458;font-weight:700>string</span> <span style=color:#d14>`header:&#34;Content-Type&#34;`</span>
</span></span><span style=display:flex><span>  Authorization <span style=color:#458;font-weight:700>string</span> <span style=color:#d14>`cookie:&#34;Authorization&#34;`</span>
</span></span><span style=display:flex><span>  Data <span style=color:#000;font-weight:700>struct</span> {
</span></span><span style=display:flex><span>    Replicas <span style=color:#458;font-weight:700>int</span> <span style=color:#d14>`json:&#34;replicas&#34;`</span>
</span></span><span style=display:flex><span>  } <span style=color:#d14>`body:&#34;&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=非-body-数据处理>非 Body 数据处理</h3><p>对于非 Body 数据， gin 原生已经为了提供了绑定方法， 之前我们已经改造出了 <code>BindOnly</code> 方法， 直接使用即可。所以这部分相对简单。</p><p>但是，在对 <code>Query</code> 的处理时， 遇到了一个些问题。 由于 gin 之前对 <code>Query</code> 的处理使用时 <code>form</code> tag。这个在 POST 提交 form 表达的的时候会产生变量名的冲突。 因此这里使用了 <code>query</code> tag 名。</p><p>正好， 在 <code>gin</code> 提供了方法 <code>mapFormByTag</code>， 可以方便的绑定的自定义的的 tag。</p><blockquote><p><a href=https://github.com/gin-gonic/gin/blob/v1.7.4/binding/form_mapping.go#L31 target=_blank rel=noopener>https://github.com/gin-gonic/gin/blob/v1.7.4/binding/form_mapping.go#L31</a></p></blockquote><h3 id=body-数据处理>Body 数据处理</h3><p>在处理这部分的时候， 需要考虑</p><ol><li>由于原生 <code>mapFormByTag</code> 是递归处理 <code>params</code> 的， 所以要如何屏蔽 <strong>非body</strong> 的影响。</li><li>如何将 <code>params.Data</code> 和 <code>req.Body</code> 对应起来。</li></ol><p>这部分处理， 用到了 <code>go 的 反射</code> ， 想办法通过反射，把 <code>body</code> tag 的结构体返回， 然后调用原生的 <code>BindBodyOnly</code> 方法即可。</p><blockquote><p><a href=https://github.com/tangx/ginbinder/blob/v0.0.1/binding/request.go#L76-L101 target=_blank rel=noopener>https://github.com/tangx/ginbinder/blob/v0.0.1/binding/request.go#L76-L101</a></p></blockquote><p>反射找 tag 只能算是<strong>基本操作</strong></p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>		<span style=color:#998;font-style:italic>// find body struct
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>		<span style=color:#000;font-weight:700>if</span> reflect.<span style=color:#900;font-weight:700>Indirect</span>(vf).<span style=color:#900;font-weight:700>Kind</span>() <span style=color:#000;font-weight:700>==</span> reflect.Struct {
</span></span><span style=display:flex><span>			<span style=color:#998;font-style:italic>// body must not has tag &#34;query&#34;
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>			<span style=color:#000;font-weight:700>if</span> <span style=color:#900;font-weight:700>hasTag</span>(vf, <span style=color:#d14>&#34;query&#34;</span>) <span style=color:#000;font-weight:700>||</span> <span style=color:#900;font-weight:700>hasTag</span>(vf, <span style=color:#d14>&#34;header&#34;</span>) <span style=color:#000;font-weight:700>||</span>
</span></span><span style=display:flex><span>				<span style=color:#900;font-weight:700>hasTag</span>(vf, <span style=color:#d14>&#34;cookie&#34;</span>) <span style=color:#000;font-weight:700>||</span> <span style=color:#900;font-weight:700>hasTag</span>(vf, <span style=color:#d14>&#34;uri&#34;</span>) {
</span></span><span style=display:flex><span>				<span style=color:#0086b3>panic</span>(ErrInvalidTagInRequestBody)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#000;font-weight:700>return</span> vf.<span style=color:#900;font-weight:700>Addr</span>().<span style=color:#900;font-weight:700>Interface</span>()
</span></span><span style=display:flex><span>		}
</span></span></code></pre></td></tr></table></div></div><p>但是需要注意的是</p><ol><li><code>reflect.Indirect</code> 获取对象的真实类型， 在进行比较，否则 <strong><code>vf</code></strong> 是指针时，无法正确比对。</li><li>在返回时 <code>return vf.Addr().Interface()</code> 需要首先通过 <code>vf.Addr()</code> 的 <code>vf</code> 的指针， 否则 <code>params.Data</code> 时结构体时，后续无法绑定数据。</li><li>为了解决 body 中的 tag 污染， 就强制 tag 出现违禁词就 panic。</li></ol><h2 id=封装一下>封装一下</h2><p>有了自建的 <code>request binder</code> 之后， 就来简单的封装一下， 让调用更简单。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>ShouldBindRequest</span>(c <span style=color:#000;font-weight:700>*</span>gin.Context, obj <span style=color:#000;font-weight:700>interface</span>{}) <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span>  <span style=color:#998;font-style:italic>// 为了获取 uri 的数据
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>	params <span style=color:#000;font-weight:700>:=</span> <span style=color:#0086b3>make</span>(<span style=color:#000;font-weight:700>map</span>[<span style=color:#458;font-weight:700>string</span>][]<span style=color:#458;font-weight:700>string</span>)
</span></span><span style=display:flex><span>	<span style=color:#000;font-weight:700>for</span> _, v <span style=color:#000;font-weight:700>:=</span> <span style=color:#000;font-weight:700>range</span> c.Params {
</span></span><span style=display:flex><span>		params[v.Key] = []<span style=color:#458;font-weight:700>string</span>{v.Value}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#998;font-style:italic>// 使用自建的 request binder
</span></span></span><span style=display:flex><span><span style=color:#998;font-style:italic></span>	<span style=color:#000;font-weight:700>return</span> binding.Request.<span style=color:#900;font-weight:700>Bind</span>(obj, c.Request, params)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></div><div class=post-archive><ul class=post-copyright><img src=/mp/qrcode.png><br><li><strong>原文链接：</strong><a href=https://typonotes.com/posts/2021/08/20/ginbinder-how-to-develop/>https://typonotes.com/posts/2021/08/20/ginbinder-how-to-develop/</a></li><li>本文为原创文章，转载注明出处。</li><li>欢迎 <strong>扫码关注公众号</strong>
<span style=background-color:#e8e8e9><code>Go与云原生</code></span>
或 <strong>订阅网站</strong>
<span style=background-color:#e8e8e9><a href=https://typonotes.com/>https://typonotes.com/</a></span>
。</li><li>第一时间看后续精彩文章。觉得好的话，请猛击文章右下角「在看」，感谢支持。</li><li style=word-break:break-all></li></ul><br></div><div class=post-archive><h2>相关文章</h2><ul class=listing><li><a href=/posts/2021/08/19/ginbinder/>ginbinder 一次绑定所有 request 参数</a></li><li><a href=/posts/2021/08/18/go117-generic-preview/>go1.17泛型尝鲜</a></li><li><a href=/posts/2021/07/28/ioc-by-gin-context/>golang gin 使用 context 实现 ioc</a></li><li><a href=/posts/2021/07/27/ioc-by-golang-context/>golang 使用 Context 实现 IoC 容器</a></li><li><a href=/posts/2021/06/22/golang-block/>i:=i ? Golang Block 到底是什么？ 怎么就能解决闭包变量冲突了？</a></li></ul></div><div class="post-meta meta-tags"><ul class=clearfix><li><a href=/tags/golang target=_blank>golang</a></li></ul></div></article><div class="post bg-white"><script src=https://utteranc.es/client.js repo=tangx/tangx.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div><footer id=footer><div>&copy; 2024 <a href=https://typonotes.com/>老麦的书房 By 老麦</a>
| <a rel=nofollow target=_blank href=http://beian.miit.gov.cn/>蜀ICP备16002016号</a></div><br><div><div class=github-badge><a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a></div><div class=github-badge><a href=https://tangx.in/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">老麦</span></a></div><div class=github-badge><a href=https://github.com/tangx/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a></div></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[["$","$"]],processEscapes:!0}}</script><script src='//cdn.bootcdn.net/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>
<a id=rocket href=#top></a>
<script type=text/javascript src='/js/totop.js?v=0.0.0' async></script><style type=text/css>div.highlight{position:relative;margin:1em 0}.copy-code{display:none;position:absolute;top:4px;right:4px;color:rgba(255,255,255,.8);background:rgba(78,78,78,.8);border-radius:var(--radius);padding:0 5px;font:inherit;user-select:none;cursor:pointer;border:0;--radius:8px}div.highlight:hover .copy-code,pre:hover .copy-code{display:block}</style><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async></script></div><div id=secondary><section class=widget></section><section class=widget><section class=widget><h3 class=widget-title style=color:red>福利派送</h3><ul class=widget-list><li><p style=color:red><strong>（免费星球）「运维成长路线」</strong></p><a href=https://wx.zsxq.com/ title=（免费星球）「运维成长路线」 target=_blank style=color:red><img src=/assets/tttuigguang/devops-camp-01.jpeg></a></li><li><p style=color:red><strong>又拍云免费 CDN</strong></p><a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" title="又拍云免费 CDN" target=_blank style=color:red><img src=/assets/tttuigguang/upyun.png></a></li></ul></section></section><section class=widget><h3 class=widget-title>最近文章</h3><ul class=widget-list><li><a href=https://typonotes.com/posts/2024/07/19/nodejs-prisma-connect-db-in-sslmode/ title="Nodejs Prisma Connect DB in Sslmode" target=_blank>Nodejs Prisma Connect DB in Sslmode</a></li><li><a href=https://typonotes.com/posts/2024/06/06/aliyun-ack-flannel-network-issue/ title="Aliyun ACK 集群 Flannel 多路由表故障" target=_blank>Aliyun ACK 集群 Flannel 多路由表故障</a></li><li><a href=https://typonotes.com/posts/2024/03/29/cobrautils-bind-parameters/ title="Cobrautils: 让绑定参数更简单" target=_blank>Cobrautils: 让绑定参数更简单</a></li><li><a href=https://typonotes.com/posts/2024/03/25/k8s-api-import-chain-problem/ title="K8s API 依赖导入链的版本问题" target=_blank>K8s API 依赖导入链的版本问题</a></li><li><a href=https://typonotes.com/posts/2024/03/19/cors-rules/ title="Cors Rules" target=_blank>Cors Rules</a></li><li><a href=https://typonotes.com/posts/2024/03/05/technique-english/ title="Technique English" target=_blank>Technique English</a></li><li><a href=https://typonotes.com/posts/2024/03/05/karabiner-keyboard-assistant/ title="Karabiner Keyboard Assistant" target=_blank>Karabiner Keyboard Assistant</a></li><li><a href=https://typonotes.com/posts/2024/02/26/json-server-not-found/ title="Json Server Not Found" target=_blank>Json Server Not Found</a></li><li><a href=https://typonotes.com/posts/2024/02/26/promql-learning-book/ title="PromQL 从入门到精通（电子书）" target=_blank>PromQL 从入门到精通（电子书）</a></li><li><a href=https://typonotes.com/posts/2024/02/20/a-simple-optimizion-for-nodejs-dockerfile/ title="一个关于 Nodejs Dockerfile 的小优化" target=_blank>一个关于 Nodejs Dockerfile 的小优化</a></li></ul></section><section class=widget><h3 class=widget-title><a href=/categories/>分类</a></h3><ul class=widget-list><li><a href=https://typonotes.com/categories/linux/>linux (1)</a></li><li><a href=https://typonotes.com/categories/aliyun/>aliyun (3)</a></li><li><a href=https://typonotes.com/categories/blog/>blog (11)</a></li><li><a href=https://typonotes.com/categories/books/>books (13)</a></li><li><a href=https://typonotes.com/categories/cloudnative/>cloudnative (9)</a></li><li><a href=https://typonotes.com/categories/database/>database (6)</a></li><li><a href=https://typonotes.com/categories/devops/>devops (1)</a></li><li><a href=https://typonotes.com/categories/devops-camp/>devops-camp (2)</a></li><li><a href=https://typonotes.com/categories/devopscamp/>devopscamp (10)</a></li><li><a href=https://typonotes.com/categories/docker/>docker (10)</a></li><li><a href=https://typonotes.com/categories/english/>english (2)</a></li><li><a href=https://typonotes.com/categories/gitlab/>gitlab (1)</a></li><li><a href=https://typonotes.com/categories/golang/>golang (15)</a></li><li><a href=https://typonotes.com/categories/heroku/>heroku (1)</a></li><li><a href=https://typonotes.com/categories/istio/>istio (16)</a></li><li><a href=https://typonotes.com/categories/k8sailor/>k8sailor (19)</a></li><li><a href=https://typonotes.com/categories/kubebuilder-zero-to-one/>kubebuilder-zero-to-one (15)</a></li><li><a href=https://typonotes.com/categories/kubernetes/>kubernetes (53)</a></li><li><a href=https://typonotes.com/categories/linux/>linux (6)</a></li><li><a href=https://typonotes.com/categories/logging/>logging (3)</a></li><li><a href=https://typonotes.com/categories/monitor/>monitor (8)</a></li><li><a href=https://typonotes.com/categories/nginx/>nginx (2)</a></li><li><a href=https://typonotes.com/categories/nodejs/>nodejs (2)</a></li><li><a href=https://typonotes.com/categories/only-one/>only-one (7)</a></li><li><a href=https://typonotes.com/categories/opentelemetry/>opentelemetry (1)</a></li><li><a href=https://typonotes.com/categories/redis/>redis (2)</a></li><li><a href=https://typonotes.com/categories/sharing/>sharing (4)</a></li><li><a href=https://typonotes.com/categories/shell/>shell (1)</a></li><li><a href=https://typonotes.com/categories/vue3/>vue3 (2)</a></li><li><a href=https://typonotes.com/categories/%E5%91%BD%E4%BB%A4%E5%B7%A5%E5%85%B7/>命令工具 (1)</a></li><li><a href=https://typonotes.com/categories/%E9%9A%8F%E7%AC%94/>随笔 (1)</a></li></ul></section><section class=widget><h3 class=widget-title><a href=/tags/>标签</a></h3><div class=tagcloud><a href=https://typonotes.com/tags/MSSQL/>MSSQL</a>
<a href=https://typonotes.com/tags/SQL%E6%B3%A8%E5%85%A5/>SQL注入</a>
<a href=https://typonotes.com/tags/XSS/>XSS</a>
<a href=https://typonotes.com/tags/XXE/>XXE</a>
<a href=https://typonotes.com/tags/aliyun/>aliyun</a>
<a href=https://typonotes.com/tags/ansible/>ansible</a>
<a href=https://typonotes.com/tags/apt/>apt</a>
<a href=https://typonotes.com/tags/aws/>aws</a>
<a href=https://typonotes.com/tags/axios/>axios</a>
<a href=https://typonotes.com/tags/backup/>backup</a>
<a href=https://typonotes.com/tags/blog/>blog</a>
<a href=https://typonotes.com/tags/calico/>calico</a>
<a href=https://typonotes.com/tags/cdn/>cdn</a>
<a href=https://typonotes.com/tags/cephfs/>cephfs</a>
<a href=https://typonotes.com/tags/cfssl/>cfssl</a>
<a href=https://typonotes.com/tags/chatgpt/>chatgpt</a>
<a href=https://typonotes.com/tags/cicd/>cicd</a>
<a href=https://typonotes.com/tags/cli-tools/>cli-tools</a>
<a href=https://typonotes.com/tags/cloudnative/>cloudnative</a>
<a href=https://typonotes.com/tags/cobra/>cobra</a>
<a href=https://typonotes.com/tags/code/>code</a>
<a href=https://typonotes.com/tags/command/>command</a>
<a href=https://typonotes.com/tags/config/>config</a>
<a href=https://typonotes.com/tags/configmap/>configmap</a>
<a href=https://typonotes.com/tags/context/>context</a>
<a href=https://typonotes.com/tags/coredns/>coredns</a>
<a href=https://typonotes.com/tags/database/>database</a>
<a href=https://typonotes.com/tags/defer/>defer</a>
<a href=https://typonotes.com/tags/deployment/>deployment</a>
<a href=https://typonotes.com/tags/dind/>dind</a>
<a href=https://typonotes.com/tags/dns/>dns</a>
<a href=https://typonotes.com/tags/dnsx/>dnsx</a>
<a href=https://typonotes.com/tags/docker/>docker</a>
<a href=https://typonotes.com/tags/docker-compose/>docker-compose</a>
<a href=https://typonotes.com/tags/dockerfile/>dockerfile</a>
<a href=https://typonotes.com/tags/download/>download</a>
<a href=https://typonotes.com/tags/english/>english</a>
<a href=https://typonotes.com/tags/extension/>extension</a>
<a href=https://typonotes.com/tags/filebeat/>filebeat</a>
<a href=https://typonotes.com/tags/find/>find</a>
<a href=https://typonotes.com/tags/gin/>gin</a>
<a href=https://typonotes.com/tags/git/>git</a>
<a href=https://typonotes.com/tags/github/>github</a>
<a href=https://typonotes.com/tags/gitlab/>gitlab</a>
<a href=https://typonotes.com/tags/glusterfs/>glusterfs</a>
<a href=https://typonotes.com/tags/golang/>golang</a>
<a href=https://typonotes.com/tags/gorm/>gorm</a>
<a href=https://typonotes.com/tags/grafana/>grafana</a>
<a href=https://typonotes.com/tags/grep/>grep</a>
<a href=https://typonotes.com/tags/haproxy/>haproxy</a>
<a href=https://typonotes.com/tags/html5/>html5</a>
<a href=https://typonotes.com/tags/http/>http</a>
<a href=https://typonotes.com/tags/https/>https</a>
<a href=https://typonotes.com/tags/hugo/>hugo</a>
<a href=https://typonotes.com/tags/image/>image</a>
<a href=https://typonotes.com/tags/informer/>informer</a>
<a href=https://typonotes.com/tags/ingress/>ingress</a>
<a href=https://typonotes.com/tags/interface/>interface</a>
<a href=https://typonotes.com/tags/iptables/>iptables</a>
<a href=https://typonotes.com/tags/istio/>istio</a>
<a href=https://typonotes.com/tags/jira/>jira</a>
<a href=https://typonotes.com/tags/js/>js</a>
<a href=https://typonotes.com/tags/json/>json</a>
<a href=https://typonotes.com/tags/k3s/>k3s</a>
<a href=https://typonotes.com/tags/k8s/>k8s</a>
<a href=https://typonotes.com/tags/kubebuilder/>kubebuilder</a>
<a href=https://typonotes.com/tags/kubectl/>kubectl</a>
<a href=https://typonotes.com/tags/kustomize/>kustomize</a>
<a href=https://typonotes.com/tags/kustz/>kustz</a>
<a href=https://typonotes.com/tags/layout/>layout</a>
<a href=https://typonotes.com/tags/lego/>lego</a>
<a href=https://typonotes.com/tags/libaray/>libaray</a>
<a href=https://typonotes.com/tags/library/>library</a>
<a href=https://typonotes.com/tags/linux/>linux</a>
<a href=https://typonotes.com/tags/log/>log</a>
<a href=https://typonotes.com/tags/minio/>minio</a>
<a href=https://typonotes.com/tags/mysql/>mysql</a>
<a href=https://typonotes.com/tags/network/>network</a>
<a href=https://typonotes.com/tags/nginx/>nginx</a>
<a href=https://typonotes.com/tags/nodejs/>nodejs</a>
<a href=https://typonotes.com/tags/openai/>openai</a>
<a href=https://typonotes.com/tags/opentelemetry/>opentelemetry</a>
<a href=https://typonotes.com/tags/pgsql/>pgsql</a>
<a href=https://typonotes.com/tags/php/>php</a>
<a href=https://typonotes.com/tags/prisma/>prisma</a>
<a href=https://typonotes.com/tags/prometheus/>prometheus</a>
<a href=https://typonotes.com/tags/proxy/>proxy</a>
<a href=https://typonotes.com/tags/python/>python</a>
<a href=https://typonotes.com/tags/qcloud/>qcloud</a>
<a href=https://typonotes.com/tags/qiniu/>qiniu</a>
<a href=https://typonotes.com/tags/qos/>qos</a>
<a href=https://typonotes.com/tags/readonly/>readonly</a>
<a href=https://typonotes.com/tags/redis/>redis</a>
<a href=https://typonotes.com/tags/reflect/>reflect</a>
<a href=https://typonotes.com/tags/repo/>repo</a>
<a href=https://typonotes.com/tags/resetful/>resetful</a>
<a href=https://typonotes.com/tags/s3/>s3</a>
<a href=https://typonotes.com/tags/scope/>scope</a>
<a href=https://typonotes.com/tags/semimonthly-plan/>semimonthly-plan</a>
<a href=https://typonotes.com/tags/service/>service</a>
<a href=https://typonotes.com/tags/shell/>shell</a>
<a href=https://typonotes.com/tags/slice/>slice</a>
<a href=https://typonotes.com/tags/sqlmap/>sqlmap</a>
<a href=https://typonotes.com/tags/ssl/>ssl</a>
<a href=https://typonotes.com/tags/storage/>storage</a>
<a href=https://typonotes.com/tags/tag01/>tag01</a>
<a href=https://typonotes.com/tags/tag02/>tag02</a>
<a href=https://typonotes.com/tags/tech-sharing/>tech-sharing</a>
<a href=https://typonotes.com/tags/test/>test</a>
<a href=https://typonotes.com/tags/tidb/>tidb</a>
<a href=https://typonotes.com/tags/time/>time</a>
<a href=https://typonotes.com/tags/timezone/>timezone</a>
<a href=https://typonotes.com/tags/tls/>tls</a>
<a href=https://typonotes.com/tags/tools/>tools</a>
<a href=https://typonotes.com/tags/trace/>trace</a>
<a href=https://typonotes.com/tags/typescript/>typescript</a>
<a href=https://typonotes.com/tags/typora/>typora</a>
<a href=https://typonotes.com/tags/v2ray/>v2ray</a>
<a href=https://typonotes.com/tags/variable/>variable</a>
<a href=https://typonotes.com/tags/verbs/>verbs</a>
<a href=https://typonotes.com/tags/vscode/>vscode</a>
<a href=https://typonotes.com/tags/vue/>vue</a>
<a href=https://typonotes.com/tags/vue3/>vue3</a>
<a href=https://typonotes.com/tags/yaml/>yaml</a>
<a href=https://typonotes.com/tags/%E5%89%8D%E7%AB%AF/>前端</a>
<a href=https://typonotes.com/tags/%E5%8F%8D%E5%B0%84/>反射</a>
<a href=https://typonotes.com/tags/%E5%AE%89%E5%85%A8/>安全</a>
<a href=https://typonotes.com/tags/%E7%9F%A5%E8%AF%86%E6%98%9F%E7%90%83/>知识星球</a>
<a href=https://typonotes.com/tags/%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/>配置管理</a></div></section><section class=widget><h3 class=widget-title>其它</h3><ul class=widget-list><li><a href=https://typonotes.com/%20index.xml>文章 RSS</a></li></ul></section></div></div></div></div></body></html>